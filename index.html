<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="version" content="1.4"> <!-- Versão atualizada -->
    <title>Gerador de Relatórios Terapêuticos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
        body {
            font-family: 'Open Sans', sans-serif;
            background-color: #f0f4f8;
        }
        .container {
            max-width: 900px;
            margin: auto;
            padding: 2rem 1rem;
        }
        .card {
            background-color: #fff;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
        }
        .section-box {
            background-color: #fdfdfd;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid #e2e8f0;
        }
        .form-control {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            outline: none;
            transition: border-color 0.2s;
        }
        .form-control:focus {
            border-color: #6b7280;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            color: #fff;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .btn-primary {
            background-color: #60a5fa;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn-primary:hover {
            background-color: #3b82f6;
        }
        .btn-secondary {
            background-color: #d1d5db;
            color: #1f2937;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn-secondary:hover {
            background-color: #9ca3af;
        }
        .btn-danger {
            background-color: #f87171;
        }
        .btn-danger:hover {
            background-color: #ef4444;
        }
        .btn-info {
            background-color: #34d399;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn-info:hover {
            background-color: #10b981;
        }
        .btn-warning {
            background-color: #f59e0b;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn-warning:hover {
            background-color: #d97706;
        }
        .checkbox-label {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            margin-right: 0.75rem;
            margin-bottom: 0.5rem;
        }
        .checkbox-label input[type="checkbox"] {
            margin-right: 0.5rem;
            accent-color: #60a5fa;
        }
        .toast {
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.75);
            color: #fff;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            z-index: 1000;
        }
        .toast.show {
            opacity: 1;
        }
        .tab-button {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            background-color: #e5e7eb;
            cursor: pointer;
            margin-right: 0.5rem;
        }
        .tab-button.active {
            background-color: #60a5fa;
            color: white;
        }
        .admin-panel {
            display: none;
            margin-top: 2rem;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-[#f0f4f8] text-[#1f2937] p-4">

    <div class="container">
        <div class="card">
            <h1 class="text-4xl font-extrabold text-center mb-2 text-[#1f2937]">Gerador de Relatórios Terapêuticos</h1>

            <!-- Elemento gráfico da versão -->
            <div class="text-center mb-6">
                <span class="inline-block bg-gray-200 text-gray-700 text-xs font-semibold px-2.5 py-0.5 rounded-full">Versão: 1.4</span>
            </div>

            <!-- Abas de navegação -->
            <div class="flex mb-6">
                <div class="tab-button active" data-tab="main-form">Formulário Principal</div>
                <div class="tab-button" data-tab="admin-panel">Painel Administrativo</div>
            </div>

            <!-- Formulário Principal -->
            <div id="main-form">
                <!-- Seção de Informações Iniciais -->
                <div class="section-box">
                    <h2 class="text-2xl font-bold flex items-center mb-4 text-[#374151]">
                        <i class="fa-solid fa-user-circle mr-3 text-[#60a5fa]"></i>Informações Iniciais
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="nome" class="block text-sm font-medium text-gray-700 mb-1">Nome do Paciente</label>
                            <input type="text" id="nome" class="form-control" placeholder="Ex: João Silva">
                        </div>
                        <div>
                            <label for="companhia" class="block text-sm font-medium text-gray-700 mb-1">Companhia</label>
                            <input type="text" id="companhia" class="form-control" placeholder="Ex: Pai, Mãe, Professor">
                        </div>
                        <div>
                            <label for="statusCompanhia" class="block text-sm font-medium text-gray-700 mb-1">Status da Companhia</label>
                            <select id="statusCompanhia" class="form-control">
                                <option value="">Selecione...</option>
                                <!-- Opções serão carregadas dinamicamente -->
                            </select>
                        </div>
                        <div>
                            <label for="genero" class="block text-sm font-medium text-gray-700 mb-1">Gênero do Paciente</label>
                            <select id="genero" class="form-control">
                                <option value="masculino">Masculino</option>
                                <option value="feminino">Feminino</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Seção de Disposição Emocional -->
                <div class="section-box">
                    <h2 class="text-2xl font-bold flex items-center mb-4 text-[#374151]">
                        <i class="fa-solid fa-face-smile mr-3 text-[#60a5fa]"></i>Disposição Emocional
                    </h2>
                    <select id="disposicaoEmocional" class="form-control">
                        <option value="">Selecione...</option>
                        <!-- Opções serão carregadas dinamicamente -->
                    </select>
                </div>

                <!-- Demais seções (mantidas como no código original) -->
                <!-- ... (as outras seções permanecem iguais) ... -->

                <!-- Seção de Opções Finais -->
                <div class="section-box">
                    <h2 class="text-2xl font-bold flex items-center mb-4 text-[#374151]">
                        <i class="fa-solid fa-file-invoice mr-3 text-[#60a5fa]"></i>Opções Finais
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label class="checkbox-label"><input type="checkbox" id="houveDevolutiva"> Houve Devolutiva</label>
                            <label class="checkbox-label"><input type="checkbox" id="houveAvaliacao"> Houve Avaliação</label>
                        </div>
                        <div>
                            <label for="estiloTexto" class="block text-sm font-medium text-gray-700 mb-1">Estilo de Texto</label>
                            <select id="estiloTexto" class="form-control">
                                <option value="aleatorio">Aleatório</option>
                                <option value="estilo1">Estilo 1 (Formal e Direto)</option>
                                <option value="estilo2">Estilo 2 (Formal e Descritivo)</option>
                                <option value="estilo3">Estilo 3 (Menos Formal e Direto)</option>
                                <option value="estilo4">Estilo 4 (Menos Formal e Descritivo)</option>
                                <option value="estilo5">Estilo 5 (Estruturado em Tópicos)</option>
                                <option value="deepseek">DeepSeek (IA - Requer API Key)</option>
                            </select>
                        </div>
                        <div id="deepseek-config" style="display: none;">
                            <label for="deepseekKey" class="block text-sm font-medium text-gray-700 mb-1">DeepSeek API Key</label>
                            <input type="password" id="deepseekKey" class="form-control" placeholder="Insira sua chave da API DeepSeek">
                            <p class="text-xs text-gray-500 mt-1">Sua chave é armazenada apenas localmente no navegador</p>
                        </div>
                    </div>
                </div>

                <!-- Botões de Ação -->
                <div class="flex flex-col md:flex-row gap-4 mt-6">
                    <button id="gerarRelatorioBtn" class="btn btn-primary w-full md:w-auto">Gerar Relatório</button>
                    <button id="copiarRelatorioBtn" class="btn btn-secondary w-full md:w-auto">Copiar Relatório</button>
                    <button id="randomizarBtn" class="btn btn-info w-full md:w-auto">Randomizar Campos</button>
                    <button id="limparTudoBtn" class="btn btn-danger w-full md:w-auto">Limpar Tudo</button>
                </div>

                <!-- Seção de Relatório Gerado -->
                <div id="relatorioGerado" class="section-box mt-6" style="display: none;">
                    <h2 class="text-2xl font-bold flex items-center mb-4 text-[#374151]">
                        <i class="fa-solid fa-paste mr-3 text-[#60a5fa]"></i>Relatório Gerado
                    </h2>
                    <div id="relatorioContent" class="bg-[#eef2f6] text-[#1f2937] p-4 rounded-lg whitespace-pre-wrap">
                        <!-- O relatório gerado será inserido aqui -->
                    </div>
                </div>
            </div>

            <!-- Painel Administrativo -->
            <div id="admin-panel" class="admin-panel">
                <h2 class="text-2xl font-bold mb-4">Painel Administrativo</h2>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Selecionar Categoria para Editar</label>
                    <select id="adminCategory" class="form-control">
                        <option value="statusCompanhia">Status da Companhia</option>
                        <option value="disposicaoEmocional">Disposição Emocional</option>
                        <option value="expressividadeCorporal">Expressividade Corporal</option>
                        <option value="expressividadeFacial">Expressividade Facial</option>
                        <option value="posturaTonus">Postura e Tônus</option>
                        <option value="respiracao">Respiração</option>
                        <option value="recursosPacienteSonoros">Recursos do Paciente (Sonoros)</option>
                        <option value="recursosPacienteExtra">Recursos do Paciente (Extra)</option>
                        <option value="recursosTerapeutaSonoros">Recursos do Terapeuta (Sonoros)</option>
                        <option value="recursosTerapeutaExtra">Recursos do Terapeuta (Extra)</option>
                        <option value="elementosSala">Elementos da Sala</option>
                        <option value="objetivos">Objetivos</option>
                        <option value="abordagem">Abordagem</option>
                        <option value="mudancasFisicas">Mudanças Físicas</option>
                        <option value="suportePercebido">Suporte Percebido</option>
                        <option value="intercorrencias">Intercorrências</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Itens da Categoria</label>
                    <div id="adminItemsList" class="border p-3 rounded-md max-h-60 overflow-y-auto">
                        <!-- Itens serão carregados aqui -->
                    </div>
                </div>

                <div class="flex gap-2 mb-4">
                    <input type="text" id="newItemInput" class="form-control flex-grow" placeholder="Novo item">
                    <button id="addItemBtn" class="btn btn-primary">Adicionar</button>
                </div>

                <div class="flex gap-2">
                    <button id="saveAdminBtn" class="btn btn-primary">Salvar Alterações</button>
                    <button id="resetAdminBtn" class="btn btn-danger">Restaurar Padrões</button>
                </div>
            </div>

            <!-- Toast Message -->
            <div id="toast" class="toast"></div>
        </div>
    </div>

    <script>
        // Versão do script: 1.4
        // Dados padrão das categorias
        const defaultCategories = {
            statusCompanhia: [
                "aguardava na companhia de",
                "foi trazido por",
                "teve a participação ativa de",
                "teve a participação passiva de"
            ],
            disposicaoEmocional: [
                "alegre",
                "amedrontado(a)",
                "ansioso(a)",
                "calmo(a)",
                "culposo(a)",
                "depressivo(a)",
                "enciumado(a)",
                "enojado(a)",
                "envergonhado(a)",
                "entediado(a)",
                "esperançoso(a)",
                "fascinado(a)",
                "grato(a)",
                "orgulhoso(a)",
                "otimista",
                "pessimista",
                "queixoso(a)",
                "raivoso(a)",
                "saudoso(a)",
                "surpreso(a)",
                "tranquilo(a)",
                "triste",
                "desesperado(a)"
            ],
            // ... outras categorias com seus valores padrão
        };

        // Carregar categorias do localStorage ou usar os padrões
        let categories = JSON.parse(localStorage.getItem('therapyReportCategories')) || defaultCategories;

        // Função para salvar categorias no localStorage
        const saveCategories = () => {
            localStorage.setItem('therapyReportCategories', JSON.stringify(categories));
            showToast('Alterações salvas com sucesso!');
        };

        // Função para restaurar categorias padrão
        const resetToDefaultCategories = () => {
            if (confirm('Tem certeza que deseja restaurar todas as categorias para os valores padrão? Isso irá remover quaisquer itens personalizados.')) {
                categories = {...defaultCategories};
                saveCategories();
                loadCategoryOptions();
                showToast('Categorias restauradas para os valores padrão.');
            }
        };

        // Função para carregar opções nas selects do formulário
        const loadCategoryOptions = () => {
            for (const [categoryId, items] of Object.entries(categories)) {
                const selectElement = document.getElementById(categoryId);
                if (selectElement) {
                    // Limpar opções existentes (exceto a primeira opção vazia)
                    while (selectElement.options.length > 1) {
                        selectElement.remove(1);
                    }
                    
                    // Adicionar novas opções
                    items.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item;
                        option.textContent = item;
                        selectElement.appendChild(option);
                    });
                }
                
                // Para checkboxes, precisamos de uma abordagem diferente
                // Esta parte precisaria ser expandida para cada categoria de checkbox
            }
        };

        // Função para mostrar uma mensagem de toast na tela
        const showToast = (message) => {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        };

        // Função para carregar itens no painel administrativo
        const loadAdminItems = () => {
            const category = document.getElementById('adminCategory').value;
            const itemsList = document.getElementById('adminItemsList');
            itemsList.innerHTML = '';
            
            categories[category].forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex justify-between items-center py-2 border-b';
                itemDiv.innerHTML = `
                    <span>${item}</span>
                    <button class="text-red-500 delete-item" data-index="${index}">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                itemsList.appendChild(itemDiv);
            });
            
            // Adicionar event listeners para os botões de deletar
            document.querySelectorAll('.delete-item').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.closest('.delete-item').dataset.index);
                    categories[category].splice(index, 1);
                    loadAdminItems();
                });
            });
        };

        // Função para adicionar um novo item no painel administrativo
        const addNewItem = () => {
            const category = document.getElementById('adminCategory').value;
            const newItem = document.getElementById('newItemInput').value.trim();
            
            if (newItem) {
                if (!categories[category].includes(newItem)) {
                    categories[category].push(newItem);
                    document.getElementById('newItemInput').value = '';
                    loadAdminItems();
                } else {
                    showToast('Este item já existe na categoria.');
                }
            }
        };

        // Função para integrar com a API do DeepSeek
        const generateWithDeepSeek = async (data, apiKey) => {
            try {
                // Construir prompt para o DeepSeek
                const prompt = `Com base nas seguintes informações de uma sessão de musicoterapia, gere um relatório coeso e bem escrito em português do Brasil:
                
                Paciente: ${data.nome}
                Gênero: ${data.genero}
                Companhia: ${data.companhia}
                Status da Companhia: ${data.statusCompanhia}
                Disposição Emocional: ${data.disposicaoEmocional}
                Expressividade Corporal: ${data.expressividadeCorporal}
                Expressividade Facial: ${data.expressividadeFacial}
                Postura e Tônus: ${data.posturaTonus.join(', ')}
                Respiração: ${data.respiracao.join(', ')}
                Recursos Utilizados pelo Paciente: ${[...data.recursosPacienteSonoros, ...data.recursosPacienteExtra].join(', ')}
                Recursos Utilizados pelo Terapeuta: ${[...data.recursosTerapeutaSonoros, ...data.recursosTerapeutaExtra].join(', ')}
                Elementos da Sala: ${data.elementosSala.join(', ')}
                Objetivos: ${data.objetivos.join(', ')}
                Abordagem: ${data.abordagem.join(', ')}
                Desempenho Geral: ${data.desempenhoGeral}
                Comparação Histórica: ${data.comparacaoHistorica}
                Mudança Emocional: ${data.mudancaEmocional}
                Mudanças Físicas: ${data.mudancasFisicas.join(', ')}
                Suporte Percebido: ${data.suportePercebido.join(', ')}
                Nível de Suporte: ${data.nivelSuporte}
                Observações: ${data.observacoes}
                Elementos Simbólicos: ${data.elementosSimbolicos}
                Intercorrências: ${data.intercorrencias.join(', ')}
                Devolutiva: ${data.houveDevolutiva ? 'Sim' : 'Não'}
                Avaliação: ${data.houveAvaliacao ? 'Sim' : 'Não'}
                
                Gere um relatório profissional e coerente com essas informações.`;

                // Fazer a requisição para a API do DeepSeek
                const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [
                            {
                                role: 'system',
                                content: 'Você é um assistente especializado em gerar relatórios de musicoterapia com linguagem profissional e coerente.'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        temperature: 0.7,
                        max_tokens: 2000
                    })
                });

                if (!response.ok) {
                    throw new Error(`Erro na API: ${response.status}`);
                }

                const result = await response.json();
                return result.choices[0].message.content;
            } catch (error) {
                console.error('Erro ao chamar DeepSeek API:', error);
                throw new Error('Falha ao gerar relatório com IA. Verifique sua API key e conexão.');
            }
        };

        // Modificar a função generateReport para incluir a opção DeepSeek
        const generateReport = async () => {
            const nome = document.getElementById('nome').value.trim();
            if (!nome) {
                showToast('Por favor, preencha o nome do paciente.');
                return;
            }
            
            // Coletar dados do formulário (como antes)
            const data = {
                nome: nome,
                genero: getSelectedText('genero'),
                companhia: document.getElementById('companhia').value.trim(),
                statusCompanhia: getSelectedText('statusCompanhia'),
                disposicaoEmocional: getSelectedText('disposicaoEmocional'),
                // ... outros dados do formulário
            };
            
            const estiloTexto = getSelectedText('estiloTexto');
            
            // Se for estilo DeepSeek
            if (estiloTexto === 'deepseek') {
                const apiKey = document.getElementById('deepseekKey').value.trim();
                if (!apiKey) {
                    showToast('Por favor, insira uma API Key válida para usar o DeepSeek.');
                    return;
                }
                
                // Mostrar indicador de carregamento
                document.getElementById('relatorioContent').innerHTML = '<div class="loading"></div> Gerando relatório com IA...';
                document.getElementById('relatorioGerado').style.display = 'block';
                
                try {
                    const generatedReport = await generateWithDeepSeek(data, apiKey);
                    document.getElementById('relatorioContent').textContent = generatedReport;
                    showToast('Relatório gerado com IA!');
                } catch (error) {
                    document.getElementById('relatorioContent').textContent = `Erro: ${error.message}`;
                    showToast('Erro ao gerar relatório com IA.');
                }
            } else {
                // Estilos normais (como antes)
                const generatedReport = getReportText();
                document.getElementById('relatorioContent').textContent = generatedReport;
                document.getElementById('relatorioGerado').style.display = 'block';
                showToast('Relatório gerado!');
            }
        };

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Carregar opções das categorias
            loadCategoryOptions();
            
            // Configurar abas
            document.querySelectorAll('.tab-button').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab-button').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    document.getElementById('main-form').style.display = tab.dataset.tab === 'main-form' ? 'block' : 'none';
                    document.getElementById('admin-panel').style.display = tab.dataset.tab === 'admin-panel' ? 'block' : 'none';
                });
            });
            
            // Configurar painel administrativo
            document.getElementById('adminCategory').addEventListener('change', loadAdminItems);
            document.getElementById('addItemBtn').addEventListener('click', addNewItem);
            document.getElementById('saveAdminBtn').addEventListener('click', saveCategories);
            document.getElementById('resetAdminBtn').addEventListener('click', resetToDefaultCategories);
            
            // Carregar itens iniciais no painel admin
            loadAdminItems();
            
            // Mostrar/ocultar configuração do DeepSeek
            document.getElementById('estiloTexto').addEventListener('change', function() {
                document.getElementById('deepseek-config').style.display = this.value === 'deepseek' ? 'block' : 'none';
            });
            
            // Outros event listeners (como antes)
            document.getElementById('gerarRelatorioBtn').addEventListener('click', generateReport);
            // ... outros event listeners
        });

        // ... outras funções do código original (getSelectedValues, getSelectedText, getGenderedText, etc.)
    </script>
</body>
</html>
